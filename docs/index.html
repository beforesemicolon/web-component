<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Code Editor</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0,minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<script src="./examples/editor/codemirror.js"></script>
	<script src="./examples/editor/modes/javascript.js"></script>
	<script src="./examples/editor/modes/xml.js"></script>
	<script src="./examples/editor/modes/htmlmixed.js"></script>
	<script src="./examples/editor/modes/css.js"></script>
	<link rel="stylesheet" href="./examples/editor/codemirror.css">
	<link rel="stylesheet" href="./examples/editor/themes/dracula.css">
	<link rel="stylesheet" href="./examples/editor/themes/shadowfox.css">
	<link rel="stylesheet" href="./examples/editor/themes/base16-light.css">
	<link rel="stylesheet" href="./examples/editor/themes/neo.css">

	<style>
		body {
			background: #eee;
			font-family: sans-serif;
			font-size: 16px;
			margin: 0;
			padding: 50px 0 0 0;
			font-weight: 300;
		}

		#loading-indicator {
			position: fixed;
			background: rgba(0,0,0,0.8);
			justify-content: center;
			align-items: center;
			width: 100vw;
			height: 100vh;
			z-index: 10000;
			top: 0;
			left: 0;
			color: #fff;
			font-size: 2rem;
			display: none;
		}

		#loading-indicator.active {
			display: flex;
		}

		* {
			box-sizing: border-box;
		}

		.controls {
			display: flex;
			justify-content: flex-end;
			padding: 0 25px;
		}

		.CodeMirror pre.CodeMirror-line,
		.CodeMirror pre.CodeMirror-line-like {
			font-family: monospace;
			font-size: 14px;
			font-weight: 500;
			line-height: 1.4375;
			letter-spacing: 0.035rem;
		}

		main {
			margin-top: 50px;
			position: relative;
			display: flex;
			height: 90vh;
		}

		#examples-selector {
			display: none;
			padding: 10px;
			margin-bottom: 20px;
		}

		#examples-nav {
			width: 250px;
			max-width: 250px;
			min-width: 250px;
			overflow: auto;
		}

		#examples-nav h2 {
			font-size: 16px;
			padding: 0 10px;
			margin: 25px 0 5px;
			color: #aaa;
		}

		#examples-nav ul {
			list-style: none;
			margin: 0;
			padding: 0;
		}

		#examples-nav ul li {
			padding: 5px 10px;
			font-size: 12px;
			font-weight: 500;
			cursor: pointer;
		}

		#examples-nav ul li:hover {
			background: #ddd;
			color: #111;
		}

		#examples-nav ul li.active {
			background: #3d5063;
			color: #fff;
		}

		#editor-tabs {
			font-family: sans-serif;
			width: 60%;
			height: 100%;
			margin-top: -27px;
		}

		#editor-tabs label {
			display: inline-block;
			padding: 5px 20px;
			background: #eee;
			color: #666;
			border-top-left-radius: 5px;
			border-top-right-radius: 5px;
			font-size: 14px;
			font-weight: 500;
			letter-spacing: 0.05rem;
			cursor: pointer;
			border: 1px solid #3d5063;
			border-bottom: 0;
		}

		#editor-tabs label.active {
			background: #3d5063;
			color: #fff;
		}

		#editor-tabs label[for="editor-view"] {
			display: none;
		}

		#editor-tabs .wrapper {
			position: relative;
			height: 100%;
			width: 100%;
		}

		textarea + .CodeMirror {
			position: absolute;
			visibility: hidden;
		}

		textarea.active + .CodeMirror {
			visibility: visible;
		}

		#editor-view {
			width: 40%;
			height: 100%;
			display: block;
			background: #fff;
			border: 1px solid #ddd;
			z-index: 1;
		}

		@media screen and (max-width: 960px){
			main {
				flex-direction: column;
				height: 90vh;
				padding: 10px;
				margin-top: 10px;
			}

			#examples-selector {
				display: block;
			}

			#examples-nav {
				display: none;
			}

			#editor-tabs,
			#editor-view {
				width: 100%;
				height: 90vh;
			}

			#editor-tabs {
				margin-top: 0;
				border-bottom: 5px;
			}

			#editor-tabs label {
				padding: 5px 10px;
				font-size: 12px;
			}

			#editor-tabs label[for="editor-view"] {
				display: inline-block;
			}

			#editor-view {
				height: calc(100% - 92px);
				width: calc(100% - 20px);
				position: absolute;
				z-index: 1000;
				top: 96px;
				left: 10px;
				visibility: hidden;
			}

			#editor-view.active {
				visibility: visible;
			}

		}
	</style>
</head>
<body>
	<div id="loading-indicator">loading...</div>
	<div class="controls">
		<label>
			<span>Theme:</span>
			<select name="theme" id="theme-selector">
				<option value="neo">Neo</option>
				<option value="dracula">Dracula</option>
				<option value="shadowfox">Shadow Fox</option>
				<option value="base16-light">Base 16 Light</option>
			</select>
		</label>
	</div>

	<main>
		<nav id="examples-nav">
			<h2>Create</h2>
			<ul>
				<li data-file="create-component.html">Create Component</li>
				<li data-file="create-component-instance.html">Create Component Instance</li>
				<li data-file="create-context-provider-component.html">Create Context Provider Component</li>
				<li data-file="create-abstract-component.html">Create Abstract Component</li>
				<li data-file="create-global-error-component.html">Create Global Error Handler Component</li>
			</ul>

			<h2>Register</h2>
			<ul>
				<li data-file="register.html">Register Component</li>
				<li data-file="register-custom-name.html">Register Custom Named Component</li>
				<li data-file="register-all.html">Register All Components at once</li>
			</ul>

			<h2>Configuration</h2>
			<ul>
				<li data-file="config-component-mode.html">Component Mode</li>
				<li data-file="config-component-delegates-focus.html">Component Delegates Focus</li>
			</ul>

			<h2>Template</h2>
			<ul>
				<li data-file="template.html">Define Component Template</li>
				<li data-file="template-string-data.html">Dynamically Generated Template</li>
				<li data-file="template-data-binding.html">Template Data Binding</li>
				<li data-file="template-slot.html">Template Slot</li>
			</ul>

			<h2>Attributes</h2>
			<ul>
				<li data-file="attr-definition.html">Define Observed Attributes (Props)</li>
				<li data-file="attr-access.html">Access Observed Attributes</li>
				<li data-file="attr-default.html">Define Default Attributes Values</li>
			</ul>

			<h2>Properties</h2>
			<ul>
				<li data-file="properties.html">Public Properties</li>
				<li data-file="properties-private.html">Private Properties</li>
				<li data-file="properties-readonly.html">ReadOnly Properties</li>
				<li data-file="properties-shallow-update.html">Shallow Properties Update</li>
				<li data-file="properties-deep-update.html">Deep Properties Update</li>
			</ul>

			<h2>Styling</h2>
			<ul>
				<li data-file="stylesheet.html">Define Component Style</li>
				<li data-file="stylesheet-data-binding.html">Style Data Binding</li>
				<li data-file="stylesheet-extension.html">Extend Style</li>
			</ul>

<!--			<h2>Event Handling</h2>-->

<!--			<h2>Directives</h2>-->

			<h2>Lifecycles</h2>
			<ul>
				<li data-file="lifecycle-onmount.html">onMount</li>
				<li data-file="lifecycle-ondestroy.html">onDestroy</li>
				<li data-file="lifecycle-onupdate.html">onUpdate</li>
				<li data-file="lifecycle-onadoption.html">onAdoption</li>
<!--				<li data-file="lifecycle-before-update.html">beforeUpdate</li>-->
				<li data-file="lifecycle-onerror.html">onError</li>
			</ul>
		</nav>

		<div id="editor-tabs">
			<label for="js-editor" class="active">app.js</label>
			<label for="html-editor">index.html</label>
			<label for="css-editor">style.css</label>
			<label for="editor-view">result</label>
			<div class="wrapper">
				<textarea id="js-editor" class="active"></textarea>
				<textarea id="html-editor"></textarea>
				<textarea id="css-editor"></textarea>
			</div>
		</div>

		<iframe id="editor-view"></iframe>
	</main>

	<script>
      (() => {
        const commonOptions = {
          theme: 'neo',
          lineNumbers: true
        };

        const jsEditor = CodeMirror.fromTextArea(document.getElementById('js-editor'), {
          mode: "javascript",
          ...commonOptions
        })

        const htmlEditor = CodeMirror.fromTextArea(document.getElementById('html-editor'), {
          mode: "htmlmixed",
          ...commonOptions
        })

        const cssEditor = CodeMirror.fromTextArea(document.getElementById('css-editor'), {
          mode: "css",
          ...commonOptions
        })

        const editorTabs = document.getElementById('editor-tabs');
        const editorView = document.getElementById('editor-view');
        const loadingIndicator = document.getElementById('loading-indicator');
        const [jsTab, htmlTab, cssTab, resultTab] = editorTabs.children;
        const themeSelector = document.getElementById('theme-selector');
        const exampleNav = document.getElementById('examples-nav');
        let loading = false;

        let currentActiveTab = jsTab;
        let currentActiveEditor = document.getElementById(jsTab.getAttribute('for'));

        for (let tab of [jsTab, htmlTab, cssTab]) {
          tab.addEventListener('click', () => {
            currentActiveTab.classList.remove('active');
            currentActiveEditor.classList.remove('active');
            editorView.classList.remove('active');
            currentActiveTab = tab;

            currentActiveTab.classList.add('active');
            currentActiveEditor = document.getElementById(tab.getAttribute('for'));
            currentActiveEditor.classList.add('active');
          })
        }

        resultTab.onclick = () => {
          editorView.classList.toggle('active');
          resultTab.classList.toggle('active');
          currentActiveTab.classList.toggle('active');
          currentActiveTab = resultTab;
        }

        [jsEditor, cssEditor, htmlEditor].forEach(editor => {
          editor.setSize('100%', '100%')
          let timer = null;
          editor.on('change', () => {
            if (loading) {
                return;
            }
            const doc = editorView.contentDocument || editorView.contentWindow.document;

            clearTimeout(timer);
            timer = setTimeout(() => {
              const headClone = doc.head.cloneNode(true);
              const bodyClone = doc.body.cloneNode(true);

              bodyClone.innerHTML = `<main id="app-html">${htmlEditor.getValue()}</main>`;
              headClone.querySelector('#app-css').outerHTML = `<style id="app-css">${cssEditor.getValue()}</style>`;
              const scriptTag = document.createElement('script');
              scriptTag.id = 'app-js';
              scriptTag.textContent = jsEditor.getValue();
              bodyClone.appendChild(scriptTag);

              editorView.srcdoc = headClone.outerHTML + bodyClone.outerHTML;
            }, 300)
          })
        })

        themeSelector.addEventListener('change', (e) => {
          jsEditor.setOption('theme', e.target.value);
          htmlEditor.setOption('theme', e.target.value);
          cssEditor.setOption('theme', e.target.value);
        })


        const exampleSelector = document.createElement('select');
        let currentExample = localStorage.getItem('current-example');
        let currentActiveItem = document.querySelector(`[data-file="${currentExample}"]`);

        if (!currentActiveItem) {
          currentActiveItem = document.querySelector('#examples-nav li');
          currentExample = currentActiveItem.dataset.file;
          localStorage.setItem('current-example', currentActiveItem.dataset.file);
        }

        currentActiveItem.classList.add('active');
        exampleSelector.id = 'examples-selector';

        let currentGroup = null;
        [...exampleNav.children].forEach(el => {
			if (el.nodeName === 'H2') {
              currentGroup = document.createElement('optgroup');
              currentGroup.label = el.textContent;
              exampleSelector.appendChild(currentGroup);
			} else { // ul
              [...el.children].forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.dataset.file;
                opt.textContent = item.textContent;
                currentGroup.appendChild(opt);
              })
			}
        })

        exampleSelector.value = currentExample;

        exampleSelector.addEventListener('change', (e) => {
          localStorage.setItem('current-example', e.target.value)
          loadExample(e.target.value)
        })

        exampleNav.before(exampleSelector);

        exampleNav.querySelectorAll('li')
            .forEach(item => {
              item.addEventListener('click', (e) => {
                currentActiveItem.classList.remove('active')
                item.classList.add('active');
                currentActiveItem = item;
                localStorage.setItem('current-example', item.dataset.file)
                loadExample(item.dataset.file)
              })
            })

        function loadExample(fileName) {
          loading = true;
          loadingIndicator.classList.add('active');
          fetch(`./examples/${fileName}`)
            .then(res => {
              if (res.status !== 200) {
                throw new Error(`${res.status}: ${res.statusText}`)
              }

              return res.text();
            })
            .then(res => {
              const htmlMatch = res.match(/<main\s*id="app-html"\s*>(.*)<\/main>/is);
              editorView.srcdoc = res;
              editorView.onload = () => {
                const doc = editorView.contentDocument || editorView.contentWindow.document;
                jsEditor.setValue(doc.getElementById('app-js')?.textContent);
                cssEditor.setValue(doc.getElementById('app-css')?.textContent);
                htmlEditor.setValue(htmlMatch ? htmlMatch[1] : doc.getElementById('app-html')?.innerHTML);
                editorView.onload = null;
                loading = false;
                loadingIndicator.classList.remove('active');
              }
            })
            .catch(() => {
              jsEditor.setValue('');
              cssEditor.setValue('');
              htmlEditor.setValue('');
              editorView.srcdoc = '';
              loading = false;
              loadingIndicator.classList.remove('active');
            })
        }

        loadExample(currentExample);
      })()
	</script>
</body>
</html>
